---
import Layout from "../layouts/Layout.astro";
import CarFinder from "../components/solid/carFinder";
---

<Layout title="Parking car finder">
  <CarFinder client:visible />
</Layout>

<script>
  const urlB64ToUint8Array = (base64String: string) => {
    const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding)
      .replace(/\-/g, "+")
      .replace(/_/g, "/");
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
  };

  if ("serviceWorker" in navigator && "PushManager" in window) {
    const result = await Notification.requestPermission();
    if (result === "granted") {
      try {
        const registration =
          await navigator.serviceWorker.register("/service-worker.js");

        const subscribed = await registration.pushManager.getSubscription();

        if (!subscribed) {
          const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlB64ToUint8Array(
              "BKw_sWmrrYDQu8N9UpMR1tm11ziQNDklqwFmyRZ-3C8H6_t7HKF0CbVVnsGU_0Tda5fCGYeK4rixrmPMGATb8c4",
            ),
          });

          const phone = prompt("Please enter your phone number", "");

          fetch("/api/add-subscription", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ subscription, phone }),
          });
        }
      } catch (error) {
        console.error(
          "An error occurred while registering the service worker.",
        );
        console.error(error);
      }
    }
  } else {
    console.error("Browser does not support service workers or push messages.");
  }
</script>
